
TOTP Code Module for FreeRADIUS
===============================

FreeRADIUS TOTP Code Module  
Copyright (C) 2026 David M. Syzdek <david@syzdek.net>.  
All rights reserved.  


Overview
--------

The TOTP Code Module for FreeRADIUS (rlm_totp_code) registers XLAT expansions
which implement Time-Based One-Time Password Algorithm described in RFC 6238.
The codes generated by the module can be used to implement MFA within
FreeRADIUS.  This module differs from the "rlm_totp" module by generating
TOTP codes for use in XLAT expansions.  If FreeRADIUS is compiled with
OpenSSL support, then additional HMAC algorithms are supported.

Currently the following HMAC algorithms are supported:

   * Built-in algorithms
     - SHA-1 (sha1)
   * Algorithms requiring OpenSSL
     - SHA-2/SHA-224 (sha224)
     - SHA-2/SHA-256 (sha256)
     - SHA-2/SHA-384 (sha384)
     - SHA-2/SHA-512 (sha512)

rlm_totp_code has been tested with FreeRADIUS server 3.2.x.


Description of TOTP
-------------------

The Time-Based One-Time Password (TOTP) algorithm, defined in RFC 6238, is a
method for generating one time use paswords derived from the current time, a
shared secret, and shared parameters. TOTP is based upon the the HMAC-based
One-Time Password (HOTP) algorithm defined in RFC 4226.

The TOTP algorithm can be represented as:

    T         = (CurrentUnixTime - T0) / X 
    TOTP      = Truncate(HMAC_Algorithm(K, T)) % 10^Digit

Where

   * ___CurrentUnixTime___ is the current number of seconds since January 1, 1970
   * ___T0___ is number of seconds after January 1, 1970 to start counting step
   * ___X___ is the number of seconds in each step
   * ___T___ is the number of steps since ___T0___
   * ___K___ is the shared secret
   * ___HMAC_Algorithm()___ is a HMAC algorithm function such as HMAC-SHA-1
   * ___Truncate()___ is a function which dynamically truncates the hash
     returned by ___HMAC_Algorithm()___ to a 31 bit unsigned integer. This
     function is defined in RFC 4226 Section 4.2.
   * ___Digits___ is the length of the derived password


Module Configuration
--------------------

   * ___unix_time___ - specifies the UNIX time to start counting time steps.
     This is the value of  "_T0_" in RFC6238. Some implementations only
     support a value of "_0_". The default is "_0_".

   * ___time_step___ - specifies the time step in seconds. This is the value
     of "_X_" in RFC6238. The default is "_30_".

   * ___algorithm___ - specifies that HMAC algorithm to use to perform the
     calculations.  If not compiled with OpenSSL support, this option has no
     affect. The default is "_sha1_".

   * ___otp_length___ - specifies the number of digits of the One-Time-Password
     to return.  This is the value of "_Digit_" in RFC4226. The default is
     "_6_".

   * ___time_offset___ - specifies the number of seconds to add to the
     current UNIX time.  This can be used to increase or decrease the value
     of "_T_" used in RFC6238.  The default is "_0_".

   * ___allow_reuse___ - allows a user to re-use an One-Time-Password multiple
     times.  If this option is disabled, then an One-Time-Password may only be
     used once by a user.  The default is "_no_".

   * ___devel_debug___ - enables additional debug statements for developers.
     The default is "_no_".

   * ___allow_override___ - allows TOTP parameters to be overridden by RADIUS
     attributes.  This options allow users to have different TOTP paramters
     which are retrieved from a data store during authentication. The default
     is "_no_".

   * ___vsa_cache_key___ - the RADIUS vendor specific attribute which is used
     as the cache key for tracking previously used One-Time-Passwords if
     ___allow_reuse___ is disabled.  The default is "_User-Name_".

   * ___vsa_time_offset___ - the RADIUS vendor specific attribute which
     overrides the configured ___time_offset___ if ___allow_override___ is
     enabled.  The specified VSA must have a type of integer or unsigned.  The
     default is "_TOTP-Time-Offset_".

   * ___vsa_unix_time___ - the RADIUS vendor specific attribute which
     overrides the configured ___unix_time___ if ___allow_override___ is
     enabled.  The specified VSA must have a type of integer or unsigned.
     If this option is not configured, then ___unix_time___ cannot be
     overridden by a request.

   * ___vsa_time_step___ - the RADIUS vendor specific attribute which
     overrides the configured ___time_step___ if ___allow_override___ is
     enabled.  The specified VSA must have a type of integer or unsigned.
     If this option is not configured, then ___time_step___ cannot be
     overridden by a request.

   * ___vsa_otp_length___ - the RADIUS vendor specific attribute which
     overrides the configured ___otp_length___ if ___allow_override___ is
     enabled.  The specified VSA must have a type of integer or unsigned.
     If this option is not configured, then ___otp_length___ cannot be
     overridden by a request.

   * ___vsa_algorithm___ - the RADIUS vendor specific attribute which
     override the configured ___algorithm___ if ___allow_override___ is
     enabled.  The specified VSA must have a type of string. If this option is
     not configured, then ___algorithm___ cannot be overridden by a request.

The following is a example configuration which uses the default values:

      totp_code {
         unix_time         = 0
         time_step         = 30
         algorithm         = "sha1"
         time_offset       = 0
         otp_length        = 6
         allow_reuse       = false
         allow_override    = false
         devel_debug       = false
         vsa_cache_key     = "User-Name"
         vsa_time_offset   = "TOTP-Time-Offset"
      }


Module Usage
------------

The following is an example of a server using TOTP and MS-CHAP:

      server totp-mschap {
         authorize {
            # reject non-mschap authentication types
            if (control:Auth-Type == "mschap") {
               reject
            }
            
            # obtain the users' TOTP secret from a data store.  If the secret
            # is base32 encoded, set the secret to "&control:TOTP-Secret". If
            # the secret is binary, set the secret to "&control:TOTP-Key".
            -ldap
            -sql
    
            # generate OTP and set to the value of Cleartext-Password
            update control {
               Cleartext-Password := "%{totp_code:&TOTP-Secret}"
            }
            
            # verify that an error was not encountered generating the TOTP
            # One-Time-Password
            if ("%{control:Cleartext-Password}" !~ /^[0-9]{1,}$/) {
               reject
            }
            
            chap
            mschap
         }
         authenticate {
            Auth-Type CHAP {
                chap
            }
            Auth-Type MS-CHAP {
               mschap
            }
         }
      }


Installing Module
-----------------

The rlm_totp_code module must be compiled when the FreeRADIUS server is
compiled.  First download the source code for the FreeRADIUS server and 
rlm_totp_code.

Unpack the source code:

    tar -xf freeradius-server-x.x.x.tar.gz
    tar -xf rlm_totp_code-x.x.tar.gz
    mv rlm_totp_code-x.x freeradius-server-x.x.x/src/modules/rlm_totp_code

Follow the for building FreeRADIUS server from source (see below for links).


References
----------

   * [FreeRADIUS Documentation](https://wiki.freeradius.org):
     - [FreeRADIUS Modules](https://www.freeradius.org/modules/)
     - [List of xlat expansions](https://wiki.freeradius.org/config/Xlat)
     - [FreeRADIUS Development](https://www.freeradius.org/documentation/freeradius-server/current/developers/)
     - [Creating modules for FreeRADIUS v3.0.x](https://wiki.freeradius.org/contributing/Modules3)
     - [Documentation Guidelines](https://www.freeradius.org/documentation/freeradius-server/4.0.0/developers/guidelines.html)

   * Compiling FreeRADIUS
     - [Building from Source](https://www.freeradius.org/documentation/freeradius-server/current/installation/source.html)
     - [Building FreeRADIUS](https://wiki.freeradius.org/building/Home)

   * Standards:
     - [RFC 4226: HOTP: An HMAC-Based One-Time Password Algorithm](https://www.rfc-editor.org/rfc/rfc4226.html)
     - [RFC 6238: TOTP: Time-Based One-Time Password Algorithm](https://www.rfc-editor.org/rfc/rfc6238.html)

   * Source Code:
     - [TOTP Code Module for FreeRADIUS](https://github.com/syzdek/rlm_totp_code)
     - [FreeRADIUS Server](https://github.com/FreeRADIUS/freeradius-server)
     - [FreeRADIUS 3.2.x rlm_example](https://github.com/FreeRADIUS/freeradius-server/tree/v3.2.x/src/modules/rlm_example)
     - [TOTP Code Module for FreeRADIUS](https://github.com/syzdek/rlm_totp_code)

